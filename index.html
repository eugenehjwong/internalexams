<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Subject Filter</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-top: 30px; }
    .subject-checkboxes { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .subject-checkboxes label { margin-right: 15px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    textarea { width: 100%; height: 150px; margin-top: 10px; }
    button { margin-right: 10px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Student Subject Filter</h1>
  <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" />
  <div id="checkboxContainer"></div>
  <button onclick="filterStudents()">Filter Students</button>
  <h2>Filtered Students</h2>
  <div id="subjectHeader"></div>
  <table id="outputTable">
    <thead>
      <tr><th>Name</th><th>Civics Group</th><th>Exam Index Number</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <h2>Exam Index Numbers</h2>
  <textarea id="examIndexList" readonly></textarea><br />
  <button onclick="copyToClipboard()">Copy Index List</button>
  <button onclick="downloadCSV()">Export Filtered CSV</button>
  <button onclick="downloadIndexCSV()">Export Index List CSV</button>

  <script>
    let workbookData = [];
    let headers = [];

    const classPrefixes = {
      TEMPERANCE: 'TP', GENTLENESS: 'GT', FAITHFULNESS: 'FN', GOODNESS: 'GD',
      KINDNESS: 'KD', PATIENCE: 'PT', PEACE: 'PC', JOY: 'JY', LOVE: 'LV', DEVOTION: 'DV'
    };

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const reader = new FileReader();
      const file = e.target.files[0];
      reader.onload = (evt) => {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const allData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        // Find the row where headers begin
        const headerRowIndex = allData.findIndex(row =>
          row[0]?.toString().trim().toUpperCase() === 'S/N' &&
          row[1]?.toString().trim().toUpperCase() === 'NAME'
        );

        if (headerRowIndex === -1) return alert('Header row not found.');

        headers = allData[headerRowIndex];
        workbookData = allData.slice(headerRowIndex + 1);

        generateSubjectCheckboxes();
      };
      reader.readAsArrayBuffer(file);
    });

    function generateSubjectCheckboxes() {
      const checkboxContainer = document.getElementById('checkboxContainer');
      checkboxContainer.innerHTML = '<h3>Select Subjects</h3><div class="subject-checkboxes"></div>';
      const subjectSet = new Set();

      const subjectStartIndex = headers.findIndex(h => h?.toString().toLowerCase().includes('civics group')) + 1;

      for (const row of workbookData) {
        for (let i = subjectStartIndex; i < row.length; i++) {
          const val = row[i]?.toString().trim();
          if (val && val !== '-') subjectSet.add(val);
        }
      }

      const boxWrapper = checkboxContainer.querySelector('.subject-checkboxes');
      subjectSet.forEach(subject => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = subject;
        label.appendChild(checkbox);
        label.append(` ${subject}`);
        boxWrapper.appendChild(label);
      });
    }

    function getClassCode(civicsGroup) {
      const key = Object.keys(classPrefixes).find(k => civicsGroup.toUpperCase().includes(k));
      return classPrefixes[key] || 'XX';
    }

    function filterStudents() {
      const selectedSubjects = Array.from(document.querySelectorAll('.subject-checkboxes input:checked')).map(cb => cb.value.trim());
      if (selectedSubjects.length === 0) return alert('Please select at least one subject.');

      const subjectStartIndex = headers.findIndex(h => h?.toString().toLowerCase().includes('civics group')) + 1;

      const tableBody = document.querySelector('#outputTable tbody');
      tableBody.innerHTML = '';
      const indexList = [];

      workbookData.forEach(row => {
        const name = row[1];
        const civics = row[5];
        const sn = parseInt(row[0]);
        if (!name || !civics || isNaN(sn)) return;

        const subjects = row.slice(subjectStartIndex).filter(val => val && val !== '-').map(s => s.trim());
        const match = subjects.some(s => selectedSubjects.includes(s));

        if (match) {
          const code = getClassCode(civics);
          const index = `${code}${sn.toString().padStart(2, '0')}`;
          const tr = document.createElement('tr');
          [name, civics, index].forEach(text => {
            const td = document.createElement('td');
            td.textContent = text;
            tr.appendChild(td);
          });
          tableBody.appendChild(tr);
          indexList.push(index);
        }
      });

      document.getElementById('examIndexList').value = indexList.join('\n');
      document.getElementById('subjectHeader').innerHTML = `<h3>Selected Subject(s): ${selectedSubjects.join(', ')}</h3>`;
    }

    function copyToClipboard() {
      const textarea = document.getElementById('examIndexList');
      textarea.select();
      document.execCommand('copy');
      alert('Copied to clipboard');
    }

    function downloadCSV() {
      const rows = [['Name', 'Civics Group', 'Exam Index Number']];
      document.querySelectorAll('#outputTable tbody tr').forEach(tr => {
        const row = Array.from(tr.children).map(td => td.textContent);
        rows.push(row);
      });
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'filtered_students.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadIndexCSV() {
      const list = document.getElementById('examIndexList').value.trim().split('\n').filter(Boolean);
      const rows = [['Exam Index Number'], ...list.map(i => [i])];
      const csv = rows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'exam_index_numbers.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
