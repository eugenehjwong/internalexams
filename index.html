<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subject Filter Web App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    table { margin-top: 20px; width: 100%; }
    .checkbox-list { margin-bottom: 20px; }
    .copy-btn { margin-top: 10px; }
    .stats-table { margin-top: 20px; border: 1px solid #000; }
  </style>
</head>
<body>
  <h1>Filter Students by Subject</h1>
  <input type="file" id="fileInput" accept=".xlsx, .xls" />
  <div id="checkboxContainer" class="checkbox-list"></div>
  <button onclick="filterStudents()">Filter Students</button>
  
  <h2>Filtered Students</h2>
  <table id="studentTable"></table>

  <h2>Exam Index Numbers</h2>
  <textarea id="indexList" rows="10" style="width: 100%;"></textarea>
  <br>
  <button onclick="copyIndexList()" class="copy-btn">Copy Index List</button>
  <button onclick="exportToCSV()">Export Filtered List to CSV</button>

  <h2>Group Statistics</h2>
  <table id="groupStats" class="stats-table"></table>

  <script>
    let studentData = [];
    let headers = [];
    let civicsGroupIndex;
    let subjectColumns = [];

    const classCodeMap = {
      "TEMPERANCE": "TP", "GENTLENESS": "GT", "FAITHFULNESS": "FN", "GOODNESS": "GD",
      "KINDNESS": "KD", "PATIENCE": "PT", "PEACE": "PC", "JOY": "JY",
      "LOVE": "LV", "DEVOTION": "DV"
    };

    document.getElementById("fileInput").addEventListener("change", function (e) {
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const allData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const headerRowIndex = allData.findIndex(row => row[0] === "S/N" && row[1] === "Name");
        headers = allData[headerRowIndex];
        studentData = allData.slice(headerRowIndex + 1);

        civicsGroupIndex = headers.findIndex(h => h && h.toString().toLowerCase().includes("civics group"));
        subjectColumns = headers.slice(civicsGroupIndex + 1);

        let subjectSet = new Set();
        studentData.forEach(row => {
          row.slice(civicsGroupIndex + 1).forEach(cell => {
            const subject = (cell || '').toString().trim();
            if (subject && subject !== '-') subjectSet.add(subject);
          });
        });

        renderCheckboxes(Array.from(subjectSet).sort());
      };
      reader.readAsArrayBuffer(e.target.files[0]);
    });

    function renderCheckboxes(subjects) {
      const container = document.getElementById("checkboxContainer");
      container.innerHTML = "<strong>Select Subjects:</strong><br>";
      subjects.forEach(subject => {
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = subject;
        checkbox.name = "subjectFilter";

        const label = document.createElement("label");
        label.textContent = subject;
        label.style.marginRight = "10px";

        container.appendChild(checkbox);
        container.appendChild(label);
        container.appendChild(document.createElement("br"));
      });
    }

    function generateExamIndex(civics, sn) {
      let prefix = "";
      for (const [key, val] of Object.entries(classCodeMap)) {
        if (civics.toUpperCase().includes(key)) {
          prefix = val;
          break;
        }
      }
      const num = String(sn).padStart(2, '0');
      return prefix + num;
    }

    function filterStudents() {
      const selectedSubjects = Array.from(document.querySelectorAll('input[name="subjectFilter"]:checked')).map(cb => cb.value);
      if (selectedSubjects.length === 0) return;

      const filtered = [];
      const indexSet = new Set();
      const groupCount = {};
      const indexList = [];

      studentData.forEach(row => {
        const sn = row[0];
        const name = row[1];
        const civics = row[civicsGroupIndex];
        const subjects = row.slice(civicsGroupIndex + 1).map(cell => (cell || '').trim());

        if (selectedSubjects.some(subject => subjects.includes(subject))) {
          const index = generateExamIndex(civics, sn);
          if (!indexSet.has(index)) {
            filtered.push([sn, name, civics, index]);
            indexList.push(index);
            indexSet.add(index);
            groupCount[civics] = (groupCount[civics] || 0) + 1;
          }
        }
      });

      renderStudentTable(filtered);
      renderIndexList(indexList);
      renderStatsTable(groupCount);
    }

    function renderStudentTable(data) {
      const table = document.getElementById("studentTable");
      table.innerHTML = "";
      const header = ["S/N", "Name", "Civics Group", "Exam Index No."];
      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      header.forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      data.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
    }

    function renderIndexList(list) {
      document.getElementById("indexList").value = list.join("\n");
    }

    function copyIndexList() {
      const textarea = document.getElementById("indexList");
      textarea.select();
      document.execCommand("copy");
    }

    function renderStatsTable(stats) {
      const table = document.getElementById("groupStats");
      table.innerHTML = "";
      let total = 0;

      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      ["Civics Group", "No. of Students"].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      Object.entries(stats).forEach(([group, count]) => {
        total += count;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${group}</td><td>${count}</td>`;
        tbody.appendChild(tr);
      });
      const totalRow = document.createElement("tr");
      totalRow.innerHTML = `<td><strong>Total</strong></td><td><strong>${total}</strong></td>`;
      tbody.appendChild(totalRow);
      table.appendChild(tbody);
    }

    function exportToCSV() {
      const table = document.getElementById("studentTable");
      if (!table.rows.length) return;

      let csv = [];
      for (let row of table.rows) {
        let cols = Array.from(row.cells).map(cell => `"${cell.innerText}"`).join(",");
        csv.push(cols);
      }

      const blob = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "filtered_students.csv";
      link.click();
    }
  </script>
</body>
</html>
