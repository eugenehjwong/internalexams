<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Subject Filter</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 8px; }
    table { width: 100%; margin-top: 10px; }
    .checkbox-container { display: flex; flex-wrap: wrap; gap: 10px; }
    .checkbox-container label { white-space: nowrap; }
    #copyButton { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Student Subject Filter</h1>
  <input type="file" id="upload" accept=".xlsx, .xls, .csv" /><br><br>
  <div id="subject-selection"></div>
  <button onclick="filterStudents()">Filter Students</button>

  <h2>Filtered Students</h2>
  <div id="filtered-students"></div>

  <h2>Exam Index Numbers</h2>
  <textarea id="examIndexes" rows="10" style="width: 100%;"></textarea><br>
  <button onclick="copyIndexes()" id="copyButton">Copy to Clipboard</button>
  <button onclick="exportCSV()">Export Filtered List to CSV</button>
  <button onclick="exportIndexList()">Export Index Numbers to CSV</button>

  <h2>Summary by Civics Group</h2>
  <div id="summary"></div>

<script>
let studentData = [];
let subjectSet = new Set();

const CLASS_CODES = {
  "TEMPERANCE": "TP",
  "GENTLENESS": "GT",
  "FAITHFULNESS": "FN",
  "GOODNESS": "GD",
  "KINDNESS": "KD",
  "PATIENCE": "PT",
  "PEACE": "PC",
  "JOY": "JY",
  "LOVE": "LV",
  "DEVOTION": "DV"
};

function parseExcel(file) {
  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    const headerRow = jsonData.find(row => row[0] === "S/N" && row[1] === "Name");
    const startIndex = jsonData.indexOf(headerRow);
    const headers = jsonData[startIndex];
    const dataRows = jsonData.slice(startIndex + 1);

    studentData = dataRows.map(row => {
      const student = {};
      headers.forEach((header, i) => {
        student[header] = row[i];
      });
      return student;
    });

    studentData.forEach(student => {
      headers.slice(6).forEach(h => {
        const val = student[h];
        if (val && val !== "-" && typeof val === "string") {
          subjectSet.add(val.trim());
        }
      });
    });

    displaySubjects();
  };
  reader.readAsArrayBuffer(file);
}

function displaySubjects() {
  const container = document.getElementById("subject-selection");
  container.innerHTML = "<h2>Select Subject(s)</h2>";
  const checkboxContainer = document.createElement("div");
  checkboxContainer.className = "checkbox-container";
  Array.from(subjectSet).sort().forEach(subject => {
    const label = document.createElement("label");
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = subject;
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(subject));
    checkboxContainer.appendChild(label);
  });
  container.appendChild(checkboxContainer);
}

function generateExamIndex(civicsGroup, sn) {
  const classKey = Object.keys(CLASS_CODES).find(k => civicsGroup.toUpperCase().includes(k));
  const prefix = classKey ? CLASS_CODES[classKey] : "XX";
  const number = String(sn).padStart(2, '0');
  return prefix + number;
}

function filterStudents() {
  const checkboxes = document.querySelectorAll("#subject-selection input[type=checkbox]:checked");
  const selectedSubjects = Array.from(checkboxes).map(cb => cb.value.trim());
  const results = [];
  const seenIndexes = new Set();
  const civicsCounts = {};

  studentData.forEach(student => {
    const sn = student["S/N"];
    const name = student["Name"];
    const group = student["Civics Group"];
    const subjects = Object.values(student).slice(6).filter(val => val && val !== "-");

    const match = subjects.some(sub => selectedSubjects.includes(sub.trim()));
    if (match) {
      const index = generateExamIndex(group, sn);
      if (!seenIndexes.has(index)) {
        results.push({ sn, name, group, index });
        seenIndexes.add(index);
        civicsCounts[group] = (civicsCounts[group] || 0) + 1;
      }
    }
  });

  const table = document.createElement("table");
  const thead = document.createElement("thead");
  thead.innerHTML = "<tr><th>S/N</th><th>Name</th><th>Civics Group</th><th>Exam Index No.</th></tr>";
  const tbody = document.createElement("tbody");
  results.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row.sn}</td><td>${row.name}</td><td>${row.group}</td><td>${row.index}</td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(thead);
  table.appendChild(tbody);
  document.getElementById("filtered-students").innerHTML = "";
  document.getElementById("filtered-students").appendChild(table);

  // Output index numbers to text area
  document.getElementById("examIndexes").value = results.map(r => r.index).join("\n");

  // Summary
  const summaryTable = document.createElement("table");
  summaryTable.innerHTML = "<tr><th>Civics Group</th><th>Number of Students</th></tr>" +
    Object.entries(civicsCounts).map(([group, count]) => `<tr><td>${group}</td><td>${count}</td></tr>`).join("");
  const totalRow = `<tr><td><strong>Total</strong></td><td><strong>${results.length}</strong></td></tr>`;
  summaryTable.innerHTML += totalRow;
  document.getElementById("summary").innerHTML = "";
  document.getElementById("summary").appendChild(summaryTable);
}

function copyIndexes() {
  const textarea = document.getElementById("examIndexes");
  textarea.select();
  document.execCommand("copy");
}

function exportCSV() {
  const rows = [["S/N", "Name", "Civics Group", "Exam Index No."]];
  document.querySelectorAll("#filtered-students tbody tr").forEach(tr => {
    const cells = Array.from(tr.children).map(td => td.textContent);
    rows.push(cells);
  });
  downloadCSV(rows, "filtered_students.csv");
}

function exportIndexList() {
  const lines = document.getElementById("examIndexes").value.split("\n").map(i => [i]);
  downloadCSV([["Exam Index No."]].concat(lines), "exam_index_list.csv");
}

function downloadCSV(data, filename) {
  const csv = data.map(row => row.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Event Listener
upload.addEventListener("change", e => parseExcel(e.target.files[0]));
</script>
</body>
</html>
