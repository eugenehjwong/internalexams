<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Subject Filter App</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { font-size: 22px; }
    h2 { margin-top: 20px; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; }
    table, th, td { border: 1px solid #ccc; padding: 5px; }
    th { background: #f0f0f0; }
    .checkbox-list { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .btn { margin: 5px; padding: 8px 12px; }
    #results { margin-top: 20px; }
    #indexList { white-space: pre; background: #f9f9f9; border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
  </style>
</head>
<body>

<h1>Student Subject Filter App</h1>

<input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
<div id="subjectList" class="checkbox-list"></div>
<button id="filterBtn" class="btn">Filter Students</button>

<button id="copyBtn" class="btn">Copy Index Numbers</button>
<button id="exportCSVBtn" class="btn">Export as CSV</button>
<button id="exportExcelBtn" class="btn">Export as Excel</button>

<h2>Filtered Results</h2>
<div id="results"></div>

<h2>Exam Index Numbers</h2>
<pre id="indexList"></pre>


<h2>Check Student Subjects</h2>
<input type="text" id="indexInput" placeholder="Enter Exam Index (e.g., GD23)" />
<button id="checkBtn" class="btn">Check Subjects</button>
<div id="checkResults"></div>

<script>
let students = [];
let allSubjects = [];

const classPrefixes = {
  "TEMPERANCE": "TP", "GENTLENESS": "GT", "FAITHFULNESS": "FN",
  "GOODNESS": "GD", "KINDNESS": "KD", "PATIENCE": "PT",
  "PEACE": "PC", "JOY": "JY", "LOVE": "LV", "DEVOTION": "DV"
};

document.getElementById("fileInput").addEventListener("change", handleFile, false);

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    const data = evt.target.result;
    const workbook = XLSX.read(data, { type: "binary" });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

    // Find header row
    const headerRowIndex = json.findIndex(row =>
      Object.values(row).includes("S/N") &&
      Object.values(row).includes("Name") &&
      Object.values(row).includes("Civics Group")
    );
    if (headerRowIndex === -1) {
      alert("Could not find table headers (S/N, Name, Civics Group)");
      return;
    }

    const headers = Object.values(json[headerRowIndex]);
    const snIndex = headers.indexOf("S/N");
    const nameIndex = headers.indexOf("Name");
    const civicsIndex = headers.indexOf("Civics Group");

    students = [];
    for (let i = headerRowIndex + 1; i < json.length; i++) {
      const row = Object.values(json[i]);
      if (!row[snIndex] || !row[nameIndex] || !row[civicsIndex]) continue;

      const civics = row[civicsIndex];
      const sn = parseInt(row[snIndex]);
      const name = row[nameIndex];
      const subjects = row.slice(civicsIndex + 1).filter(v => v && v !== "-");

      students.push({ sn, name, civics, subjects });
    }

    // Build subject list (exclude 5-digit numeric codes)
    const subjectSet = new Set();
    students.forEach(s => s.subjects.forEach(sub => {
      if (!/^\d{5}$/.test(sub)) {
        subjectSet.add(sub);
      }
    }));
    allSubjects = Array.from(subjectSet).sort();

    const subjectListDiv = document.getElementById("subjectList");
    subjectListDiv.innerHTML = "";
    allSubjects.forEach(sub => {
      const label = document.createElement("label");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = sub;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(" " + sub));
      subjectListDiv.appendChild(label);
      subjectListDiv.appendChild(document.createElement("br"));
    });
  };
  reader.readAsBinaryString(file);
}

function getExamIndex(civics, sn) {
  let prefix = "XX";
  for (let key in classPrefixes) {
    if (civics.toUpperCase().includes(key)) {
      prefix = classPrefixes[key];
      break;
    }
  }
  return prefix + String(sn).padStart(2, "0");
}

document.getElementById("filterBtn").addEventListener("click", () => {
  const selectedSubjects = Array.from(document.querySelectorAll("#subjectList input:checked")).map(cb => cb.value);
  if (selectedSubjects.length === 0) {
    alert("Please select at least one subject");
    return;
  }

  const filtered = students.filter(s => s.subjects.some(sub => selectedSubjects.includes(sub)));
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  // Table
  const table = document.createElement("table");
  const thead = document.createElement("thead");
  thead.innerHTML = "<tr><th>Name</th><th>Civics Group</th><th>Exam Index</th></tr>";
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  filtered.forEach(s => {
    const row = document.createElement("tr");
    row.innerHTML = `<td>${s.name}</td><td>${s.civics}</td><td>${getExamIndex(s.civics, s.sn)}</td>`;
    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  resultsDiv.appendChild(table);

  // Group counts
  const groupCounts = {};
  filtered.forEach(s => {
    groupCounts[s.civics] = (groupCounts[s.civics] || 0) + 1;
  });

  const summary = document.createElement("div");
  summary.innerHTML = "<h3>Civics Group Counts</h3>";
  const ul = document.createElement("ul");
  for (let g in groupCounts) {
    const li = document.createElement("li");
    li.textContent = `${g}: ${groupCounts[g]}`;
    ul.appendChild(li);
  }
  const total = document.createElement("p");
  total.innerHTML = "<b>Total Students: " + filtered.length + "</b>";
  summary.appendChild(ul);
  summary.appendChild(total);
  resultsDiv.appendChild(summary);

  // Index list
  const indexList = filtered.map(s => getExamIndex(s.civics, s.sn)).join("\n");
  document.getElementById("indexList").textContent = indexList;

  // Store for export
  window.filteredResults = filtered;
  window.selectedSubjects = selectedSubjects;
});

document.getElementById("copyBtn").addEventListener("click", () => {
  const text = document.getElementById("indexList").textContent;
  navigator.clipboard.writeText(text);
  alert("Copied to clipboard!");
});

function sanitizeFilename(subjects, civics) {
  const x = parseInt(civics);
  const y = subjects.map(s => s.replace(/\s+/g, "_")).join("_");
  return `S${x}_${y}`;
}

document.getElementById("exportCSVBtn").addEventListener("click", () => {
  if (!window.filteredResults) return;
  const civicsNum = window.filteredResults[0].civics.match(/^\d+/);
  const filename = sanitizeFilename(window.selectedSubjects, civicsNum ? civicsNum[0] : "X");

  const rows = [["Name", "Civics Group", "Exam Index"]];
  window.filteredResults.forEach(s => {
    rows.push([s.name, s.civics, getExamIndex(s.civics, s.sn)]);
  });

  let csvContent = rows.map(e => e.join(",")).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename + ".csv";
  link.click();
});

document.getElementById("exportExcelBtn").addEventListener("click", () => {
  if (!window.filteredResults) return;
  const civicsNum = window.filteredResults[0].civics.match(/^\d+/);
  const filename = sanitizeFilename(window.selectedSubjects, civicsNum ? civicsNum[0] : "X");

  const ws_data = [["Name", "Civics Group", "Exam Index"]];
  window.filteredResults.forEach(s => {
    ws_data.push([s.name, s.civics, getExamIndex(s.civics, s.sn)]);
  });
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Filtered Results");
  XLSX.writeFile(wb, filename + ".xlsx");
});

document.getElementById("checkBtn").addEventListener("click", () => {
  const input = document.getElementById("indexInput").value.trim().toUpperCase();
  const resultDiv = document.getElementById("checkResults");
  resultDiv.innerHTML = "";

  const match = students.find(s => getExamIndex(s.civics, s.sn).toUpperCase() === input);
  if (!match) {
    resultDiv.textContent = "No student found for index " + input;
    return;
  }

  const enrolled = match.subjects;
  const notEnrolled = allSubjects.filter(sub => !enrolled.includes(sub));

  let html = `<h3>${match.name} (${match.civics}) - ${input}</h3>`;
  html += "<p><b>Enrolled Subjects:</b> " + enrolled.join(", ") + "</p>";
  html += "<p><b>Not Enrolled:</b> " + notEnrolled.join(", ") + "</p>";
  resultDiv.innerHTML = html;
});
</script>

</body>
</html>
