<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Subject Filter</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .subject-list, .level-filter { margin: 10px 0; }
    .result-table, .summary-table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    .result-table th, .result-table td, .summary-table th, .summary-table td {
      border: 1px solid #ccc; padding: 8px; text-align: left;
    }
    .result-table th, .summary-table th { background-color: #f2f2f2; }
    .btn { margin: 10px 5px; padding: 10px; cursor: pointer; }
    .index-output { white-space: pre; border: 1px solid #ccc; padding: 10px; margin-top: 10px;
      max-height: 200px; overflow-y: auto; }
  </style>
</head>
<body>
  <h2>Student Subject Filter</h2>
  <input type="file" id="fileInput" accept=".xlsx" />
  <div class="level-filter">
    <label for="levelSelect">Select Level:</label>
    <select id="levelSelect"></select>
  </div>
  <div class="subject-list" id="subjectList"></div>
  <button class="btn" onclick="filterStudents()">Filter Students</button>
  <div id="results"></div>

  <h3>Exam Index List</h3>
  <div class="index-output" id="indexList"></div>
  <button class="btn" onclick="copyIndexList()">Copy Index List</button>
  <button class="btn" onclick="exportCSV()">Export Filtered Results CSV</button>
  <button class="btn" onclick="exportExcel()">Export Filtered Results Excel</button>

  <h3>Check Student's Subjects</h3>
  <input type="text" id="examIndexInput" placeholder="Enter Exam Index (e.g., GD23)" />
  <button class="btn" onclick="checkStudentSubjects()">Check Subjects</button>
  <div id="studentSubjects"></div>

  <script>
    let workbook, students = [], subjectCols = [], civicsIndex = -1;

    const classCodes = {
      'TEMPERANCE': 'TP', 'GENTLENESS': 'GT', 'FAITHFULNESS': 'FN',
      'GOODNESS': 'GD', 'KINDNESS': 'KD', 'PATIENCE': 'PT',
      'PEACE': 'PC', 'JOY': 'JY', 'LOVE': 'LV', 'DEVOTION': 'DV'
    };

    document.getElementById('fileInput').addEventListener('change', handleFile);

    function handleFile(e) {
      const reader = new FileReader();
      reader.onload = function (e) {
        workbook = XLSX.read(e.target.result, { type: 'binary' });
        populateSheetAndSubjects();
      };
      reader.readAsBinaryString(e.target.files[0]);
    }

    function populateSheetAndSubjects() {
      let allSubjects = new Set();
      let levels = new Set();

      students = [];

      workbook.SheetNames.forEach(sheetName => {
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        const headers = json[9]; // Row 10 is the actual header
        civicsIndex = headers.indexOf("Civics Group");
        const levelIndex = headers.indexOf("Level");

        if (civicsIndex === -1 || levelIndex === -1) return;

        // Only valid subject headers (skip "-" and blanks)
        subjectCols = headers
          .map((h, i) => ({ name: h, index: i }))
          .filter(h => h.index > civicsIndex && h.name && h.name !== "-")
          .map(h => h.index);

        for (let i = 10; i < json.length; i++) {
          const row = json[i];
          const subjectEntries = subjectCols.map(index => row[index] || '')
            .map(s => s.toString().trim())
            .filter(s => s && s !== '-');

          subjec
